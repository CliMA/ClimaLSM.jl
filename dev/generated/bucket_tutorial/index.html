<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Introduction to the Land Bucket Model · ClimaLSM.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">ClimaLSM.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox"/><label class="tocitem" for="menuitem-2"><span class="docs-label">APIs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-2-1" type="checkbox"/><label class="tocitem" for="menuitem-2-1"><span class="docs-label">ClimaLSM</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../APIs/ClimaLSM/">ClimaLSM</a></li><li><a class="tocitem" href="../../APIs/SharedUtilities/">Shared Utilities</a></li><li><a class="tocitem" href="../../APIs/Soil/">Soil Models</a></li><li><a class="tocitem" href="../../APIs/Vegetation/">Vegetation Models</a></li><li><a class="tocitem" href="../../APIs/SurfaceWater/">Surface Water Models</a></li><li><a class="tocitem" href="../../APIs/Bucket/">Bucket Model</a></li></ul></li></ul></li><li><a class="tocitem" href="../../Contributing/">Contribution guide</a></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox" checked/><label class="tocitem" for="menuitem-4"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">For model developers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../model_tutorial/">Using AbstractModel functionality</a></li><li><a class="tocitem" href="../LSM_single_column_tutorial/">Intro to multi-component models</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox" checked/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">For model users</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-2-1" type="checkbox" checked/><label class="tocitem" for="menuitem-4-2-1"><span class="docs-label">A land bucket model</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Introduction to the Land Bucket Model</a><ul class="internal"><li class="toplevel"><a class="tocitem" href="#Simulating-a-standalone-bucket-model"><span>Simulating a standalone bucket model</span></a></li><li class="toplevel"><a class="tocitem" href="#References"><span>References</span></a></li></ul></li><li><a class="tocitem" href="../coupled_bucket/">Setting up a Coupled Simulation</a></li></ul></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li><a class="is-disabled">For model users</a></li><li><a class="is-disabled">A land bucket model</a></li><li class="is-active"><a href>Introduction to the Land Bucket Model</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Introduction to the Land Bucket Model</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CliMA/ClimateMachine.jl/../../.." title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Introduction-to-the-Land-Bucket-Model"><a class="docs-heading-anchor" href="#Introduction-to-the-Land-Bucket-Model">Introduction to the Land Bucket Model</a><a id="Introduction-to-the-Land-Bucket-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Introduction-to-the-Land-Bucket-Model" title="Permalink"></a></h1><p>The land bucket model implemented in ClimaLSM is based off of the models of Manabe (1969)[1], Milly and Shmakin (2002)[2], and the SLIM model (Laguë, Bonan, Swann 2019)[3], with small changes, as noted.</p><p>This tutorial explains in brief the core equations and the necessary parameters of the bucket model, and shows how to set up a simulation in standalone mode. More detail for coupled runs can be found in the ClimaCoupler.jl <a href="https://clima.github.io/ClimaCoupler.jl/dev/">documentation.</a> and in the coupled simulation <a href="https://clima.github.io/ClimaLSM.jl/dev/generated/coupled_bucket/">tutorial</a>.</p><p>At each coordinate point on the surface, we solve ordinary differential equations for the subsurface water content of land (<code>W</code>, m), the surface temperature of the land (<code>T_sfc</code>, K), and the surface water content of land (<code>Ws</code>, m). This tutorial will be modified in the future to explain simulations involving snow water equivalent, though we have set some of the groundwork for that in the code already (e.g. with albedo).</p><p>We have:</p><p><span>$\frac{d W}{dt} = I(W, P_{liq}, E),$</span></p><p><span>$\frac{d Ws}{dt} = P_{liq} - E - I(W, P_{liq}, E),$</span></p><p><span>$\frac{ρc dT_{sfc}}{dt} = - \frac{1}{d} (F_{sfc} - F_{bot}),$</span></p><p><span>$F_{sfc} = R_n+ SHF + LHF$</span></p><p><span>$R_n = -(1-α)*SW↓ -LW↓ + σT_{sfc}^4$</span></p><p><span>$F_{bot} = -κ \frac{T_{sfc} - T_{base}}{d}$</span></p><p>where <code>I</code> is the infiltration as defined in [1], <code>P_liq</code> (m/s) is the water volume flux of precipitation, <code>E</code> (m/s) is the water volume flux in evaporation, <code>ρc</code> is the volumetric heat capacity of the land,  <code>R_n</code> is the net radiation, <code>SHF</code> the sensible heat flux, <code>LHF</code> the latent heat flux, <code>α(lat, lon)</code> is the surface albedo, <code>σ</code> the Stefan-Boltzmann constant,  <code>κ</code> is the thermal conductivity, <code>T_base</code> the base temperature at depth <code>d</code>, and <code>d</code> is the soil depth. The albedo is a linear interpolation between the albedo of soil and snow, as decribed in [3].</p><p>Turbulent surface fluxes of sensible heat, latent heat, and water vapor (<code>SHF, LHF, E</code>) are computed using Monin-Obukhov theory; <code>SW↓</code> and <code>LW↓</code> are the downward fluxes in short and long wavelength bands.</p><p>Note that with the exception of precipitation and downwelling radiation, all fluxes are defined such that positive is towards the atmosphere. The bottom flux can be set to zero by setting <code>κ = 0</code>.</p><p>When computing the evaporation, we use</p><p><span>$q_{sfc} = β(W, Wf) q_{sat}(T_{sfc}, ρ_{sfc}),$</span></p><p>where β is the factor used in [1] which accounts for the land water content when it is below the saturated value. This makes use of the field capacity parameter <code>W_f</code>. This is different from other bucket models in that we modify <code>q_sfc</code> directly to account for the bucket being below saturation, rather than modify the potential evaporation rate itself via a resistance term.</p><h1 id="Simulating-a-standalone-bucket-model"><a class="docs-heading-anchor" href="#Simulating-a-standalone-bucket-model">Simulating a standalone bucket model</a><a id="Simulating-a-standalone-bucket-model-1"></a><a class="docs-heading-anchor-permalink" href="#Simulating-a-standalone-bucket-model" title="Permalink"></a></h1><p>First, we need to import necessary packages. We use <a href="https://github.com/SciML/OrdinaryDiffEq.jl">OrdinaryDiffEq.jl</a> for the timestepping, and <a href="https://github.com/SciML/DiffEqCallbacks.jl">DiffEqCallbacks.jl</a> is used as described below, for accessing the solver state during the integration.</p><pre><code class="language-julia hljs">using OrdinaryDiffEq: ODEProblem, solve, Euler
using DiffEqCallbacks</code></pre><p>We use <a href="https://github.com/CliMA/ClimaCore.jl">ClimaCore</a> for setting up the domain/coordinate points. While this infrastructure isn&#39;t really necessary for standalone simulations, adhering to it makes setting up coupled simulations very easy. It also is nice to rely on ClimaCore utilities because they have been designed in advance for running distributed simulations.</p><pre><code class="language-julia hljs">using ClimaCore</code></pre><p>We also use CLIMAParameters, which strives to ensure a common set of parameters across all Clima models, and to make parameter estimation more seamless.</p><pre><code class="language-julia hljs">import CLIMAParameters as CP</code></pre><p>Lastly, let&#39;s bring in the bucket model types (from ClimaLSM) that we will need access to.</p><pre><code class="language-julia hljs">using ClimaLSM.Bucket:
    BucketModel,
    BucketModelParameters,
    PrescribedAtmosphere,
    PrescribedRadiativeFluxes,
    BulkAlbedo
using ClimaLSM.Domains: coordinates, Point
using ClimaLSM: initialize, make_update_aux, make_ode_function</code></pre><p>We also want to plot the solution</p><pre><code class="language-julia hljs">using Plots

FT = Float64;</code></pre><p>As mentioned we use CLIMAParameters for earth parameters that are required across models (e.g. the density of water and ice, the latent heat of fusion at a reference temperature, etc). The land model requires additional parameters as described in the text above. These two sets are combined in the object <code>BucketModelParameters</code> as follows:</p><pre><code class="language-julia hljs">import ClimaLSM
include(joinpath(pkgdir(ClimaLSM), &quot;parameters&quot;, &quot;create_parameters.jl&quot;));
earth_param_set = create_lsm_parameters(FT);</code></pre><p>Define our <code>BulkAlbedo</code> model using a constant soil and snow albedo: The soil albedo is a function of coordinates, which would be (x,y) on a plane, and (lat,lon) on a sphere. In the future, we will support other albedo models.</p><pre><code class="language-julia hljs">α_soil = (coordinate_point) -&gt; FT(0.2);
α_snow = FT(0.8);
albedo = BulkAlbedo{FT}(α_snow, α_soil);</code></pre><p>The critical snow level setting the scale for when we interpolate between snow and soil albedo</p><pre><code class="language-julia hljs">S_c = FT(0.2);</code></pre><p>The field capacity of the soil</p><pre><code class="language-julia hljs">W_f = FT(0.15);</code></pre><p>The soil depth and base temperature</p><pre><code class="language-julia hljs">d_soil = FT(10.0);
T_base = FT(280.0);</code></pre><p>Roughness lengths (meters)</p><pre><code class="language-julia hljs">z_0m = FT(1e-2);
z_0b = FT(1e-3);</code></pre><p>Thermal parameters of soil</p><pre><code class="language-julia hljs">κ_soil = FT(0.0);
ρc_soil = FT(2e6);
bucket_parameters = BucketModelParameters(
    d_soil,
    T_base,
    κ_soil,
    ρc_soil,
    albedo,
    S_c,
    W_f,
    z_0m,
    z_0b,
    earth_param_set,
);</code></pre><p>Set up the model domain. At every coordinate point, we&#39;ll solve an ODE for <code>W</code>, <code>Ws</code>, and <code>T_sfc</code>. In coupled simulations run at the same resolution as the atmosphere, the bucket domain would match the bottom domain of the atmosphere model. In general, however, the two resolutions do not need to match. Here we just set up something simple - a point, appropriate for single column models.</p><pre><code class="language-julia hljs">bucket_domain = Point(; z_sfc = FT(0.0));</code></pre><p>To drive the system in standalone mode, the user must provide prescribed functions of time for the water volume flux in precipitation  for the net downward shortwave and longwave radiative energy fluxes (<code>SW↓, LW↓</code>, W/m^2), for the atmospheric temperature <code>T_a</code>, wind speed <code>u_a</code> (m/s), specific humidity <code>q_a</code>, and air density <code>ρ_a</code> (kg/m^3) at a reference height <code>h_a</code> (m), as well as for the air density <code>ρ_sfc</code> (kg/m^3) at the surface of the earth.</p><p>Here we define the model drivers, starting with downward radiation.</p><pre><code class="language-julia hljs">SW_d =
    (t) -&gt; eltype(t)(
        sin(2.0 * π * t / 86400) &gt; 0 ? 300.0 * sin(2.0 * π * t / 86400) : 0.0,
    );
LW_d =
    (t) -&gt; eltype(t)(
        sin(2.0 * π * t / 86400) &gt; 0 ? 300.0 * sin(2.0 * π * t / 86400) : 0.0,
    );
bucket_rad = PrescribedRadiativeFluxes(FT, SW_d, LW_d);</code></pre><p>Prescribed atmospheric variables</p><p>Stochastic prescipitation:</p><pre><code class="language-julia hljs">precip = (t) -&gt; eltype(t)(5e-7 * rand() * (rand() &gt; 0.97));</code></pre><p>Diurnal temperature variations:</p><pre><code class="language-julia hljs">T_atmos = (t) -&gt; eltype(t)(300.0 + 5.0 * sin(2.0 * π * t / 86400 + 7200));</code></pre><p>Constant otherwise:</p><pre><code class="language-julia hljs">u_atmos = (t) -&gt; eltype(t)(3.0);
q_atmos = (t) -&gt; eltype(t)(0.005);
h_atmos = FT(10);
ρ_atmos = (t) -&gt; eltype(t)(1.13);
ρ_sfc = FT(1.15);
bucket_atmos = PrescribedAtmosphere(
    precip,
    T_atmos,
    u_atmos,
    q_atmos,
    ρ_atmos,
    h_atmos,
    ρ_sfc,
);</code></pre><p>Then, we create the model object, which contains the drivers, parameters, domain, and is associated with the correct differential equations for the bucket model:</p><pre><code class="language-julia hljs">model = BucketModel(
    parameters = bucket_parameters,
    domain = bucket_domain,
    atmosphere = bucket_atmos,
    radiation = bucket_rad,
);</code></pre><p>Note the holder structs for the radiation and atmosphere functions: they are named <code>Prescribed</code>. In coupled simulations, we would use a different type and rely on multiple dispatch to obtain the atmospheric and radiative quantitites from the coupler.</p><p>Like all ClimaLSM models, we set up the state vector using <code>initialize</code>:</p><pre><code class="language-julia hljs">Y, p, coords = initialize(model);</code></pre><p>We can inspect the prognostic and auxiliary variables of the model:</p><pre><code class="language-julia hljs">ClimaLSM.prognostic_vars(model)
Y.bucket |&gt; propertynames</code></pre><pre><code class="nohighlight hljs">(:W, :T_sfc, :Ws, :S)</code></pre><p>The auxiliary variables in this case are the turbulent fluxes, the net radiation, and the surface specific humidity.</p><pre><code class="language-julia hljs">ClimaLSM.auxiliary_vars(model)
p.bucket |&gt; propertynames</code></pre><pre><code class="nohighlight hljs">(:q_sfc, :E, :LHF, :SHF, :R_n)</code></pre><p>Next is to set initial conditions.</p><pre><code class="language-julia hljs">Y.bucket.T_sfc .= FT(286.5);
Y.bucket.W .= FT(0.1);
Y.bucket.Ws .= FT(0.0);
Y.bucket.S .= FT(0.0);</code></pre><p>Then to create the entire right hand side function for the system of ordinary differential equations:</p><pre><code class="language-julia hljs">ode_function! = make_ode_function(model);</code></pre><p>Then set up the simulation</p><pre><code class="language-julia hljs">t0 = FT(0.0);
tf = FT(3 * 86400);
prob = ODEProblem(ode_function!, Y, (t0, tf), p);
Δt = FT(1000.0);</code></pre><p>We need a callback to get and store the auxiliary fields, as they are not stored by default.</p><pre><code class="language-julia hljs">saved_values = SavedValues(FT, ClimaCore.Fields.FieldVector);
cb = SavingCallback(
    (u, t, integrator) -&gt; copy(integrator.p),
    saved_values;
    saveat = 0:Δt:tf,
);

sol = solve(prob, Euler(); dt = Δt, saveat = 0:Δt:tf, callback = cb);</code></pre><p>Extracting the solution from what is returned by the ODE.jl commands is a bit clunky right now, but we are working on hiding some of this. <code>parent</code> extracts the underlying data from the fields stored in the ClimaCore.Fields.FieldVector, and we loop over the solution <code>sol</code> because of how the data is stored within solutions returned by ODE.jl - indexed by timestep.</p><pre><code class="language-julia hljs">W = [parent(sol.u[k].bucket.W)[1] for k in 1:length(sol.t)]
Ws = [parent(sol.u[k].bucket.Ws)[1] for k in 1:length(sol.t)]
T_sfc = [parent(sol.u[k].bucket.T_sfc)[1] for k in 1:length(sol.t)]
q_sfc =
    [parent(saved_values.saveval[k].bucket.q_sfc)[1] for k in 1:length(sol.t)]
R_n = [parent(saved_values.saveval[k].bucket.R_n)[1] for k in 1:length(sol.t)]
SHF = [parent(saved_values.saveval[k].bucket.SHF)[1] for k in 1:length(sol.t)]
LHF = [parent(saved_values.saveval[k].bucket.LHF)[1] for k in 1:length(sol.t)]
E = [parent(saved_values.saveval[k].bucket.E)[1] for k in 1:length(sol.t)]
plot(sol.t ./ 86400, W, label = &quot;W&quot;, xlabel = &quot;time (days)&quot;, ylabel = &quot;W (m)&quot;)
savefig(&quot;w.png&quot;)</code></pre><p><img src="../w.png" alt/></p><pre><code class="language-julia hljs">plot(
    sol.t ./ 86400,
    T_sfc,
    label = &quot;T_sfc&quot;,
    xlabel = &quot;time (days)&quot;,
    ylabel = &quot;T (K)&quot;,
)
savefig(&quot;t.png&quot;)</code></pre><p><img src="../t.png" alt/></p><pre><code class="language-julia hljs">plot(
    sol.t ./ 86400,
    R_n,
    label = &quot;R_n&quot;,
    xlabel = &quot;time (days)&quot;,
    ylabel = &quot;Flux (W/m^2)&quot;,
)
plot!(sol.t ./ 86400, SHF, label = &quot;SHF&quot;)
plot!(sol.t ./ 86400, LHF, label = &quot;LHF&quot;)
savefig(&quot;f.png&quot;)</code></pre><p><img src="../f.png" alt/></p><h1 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h1><p>[1] Manabe, S. (1969) CLIMATE AND THE OCEAN CIRCULATION I: The Atmospheric Circulation and the Hydrology of the Earth&#39;s Surface. Monthly Weather Review, Volume 97: Issue 11, p 739-774. [2] Milly, P. C. D. and Shmakin, A.B. (2002) Global Modeling of Land Water and Energy Balances. Part I: The Land Dynamics (LaD) Model Journal of Hydrometeorology, Volume 3: Issue 3, p 283-299. [3] Laguë, M., Bonan, G., and Swann, A. (2019) Seperating the Impact of Individual Land Surface Properties on the Terrestrial Surface Energy Budget in both the Coupled and Uncoupled Land-Atmosphere System Volume 32: Issue 18, p 5725-5744</p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../LSM_single_column_tutorial/">« Intro to multi-component models</a><a class="docs-footer-nextpage" href="../coupled_bucket/">Setting up a Coupled Simulation »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.21 on <span class="colophon-date" title="Tuesday 19 July 2022 15:00">Tuesday 19 July 2022</span>. Using Julia version 1.7.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
